{% extends "base.html" %} 
{% block title %}Panel de Auditoría de Votos{% endblock title %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* Estilo para asegurar que los hashes NO se corten, sino que salten de línea */
    .hash-complete {
        word-break: break-all; 
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: 0.75rem; 
        line-height: 1.3; 
    }
    /* ASIGNAR ANCHO MÍNIMO A LAS COLUMNAS CRIPTOGRÁFICAS */
    .hash-column {
        min-width: 250px; 
    }
    .date-column {
        min-width: 140px; 
    }
    .voter-column {
        min-width: 150px; 
    }
    .id-column {
        min-width: 60px; 
    }
    /* ESTILO PARA COLUMNAS DE RESPUESTA LEGIBLE (ADMIN VIEW) */
    .answer-column {
        min-width: 100px;
        font-weight: bold;
    }
    .text-primary-strong {
        color: #1a2b41;
    }
    /* ESTILO ADICIONAL PARA LA DESCRIPCIÓN EN PUNTOS */
    .crypto-list {
        list-style: none; 
        padding-left: 0;
        margin-bottom: 0;
    }
    .crypto-list li {
        margin-bottom: 5px;
        font-weight: 500;
    }
    /* ESTILO PARA EL CONTENEDOR CENTRAL DE VOTOS */
    .total-votes-container {
        max-width: 300px; 
        margin-left: auto;
        margin-right: auto;
    }
    .table-dark th {
        vertical-align: middle; 
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container my-5">

    <div class="row">
        <div class="col-12 text-center">
            <h1 class="text-dark fw-bolder fs-2">
                {% if is_verification_page %}
                    <i class="bi bi-patch-check-fill me-2 text-success"></i> Verificación de Participación
                {% elif is_audit_page %}
                    REGISTRO INMUTABLE DE AUDITORÍA (ADMINISTRADOR)
                {% else %}
                    <i class="bi bi-bar-chart-fill me-2 text-info"></i> REGISTRO DE RESULTADOS DE ENCUESTA
                {% endif %}
            </h1>
            <p class="lead text-muted">
                {% if is_verification_page %}
                    ¡Aquí puedes verificar el registro de tu voto para asegurar su integridad!
                {% elif is_audit_page %}
                    Detalle de la cadena de integridad y firma de no repudio
                {% else %}
                    Garantizando transparencia y capacidad de auditoría
                {% endif %}
            </p>
             {# Línea divisoria #}
            <hr class="my-4 border-secondary">
        </div>
    </div>
    
    
    {% if not is_verification_page and not is_audit_page %}
        <div class="row mb-5 mt-4 justify-content-center">
            <div class="col-md-4 mb-4 total-votes-container">
                <div class="card shadow-lg border-bottom border-primary border-5 h-100 rounded-3">
                    <div class="card-body text-center p-4">
                        <h5 class="card-title text-primary fw-bold">TOTAL DE VOTOS REGISTRADOS</h5>
                        <p class="display-3 fw-bolder text-dark mt-2">{{ total_votes }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-5 mt-4">
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 1 (Interés General)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP1" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 2 (Dificultad)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP2" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5 mt-4">
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 3 (Utilidad)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP3" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100 rounded-3">
                    <div class="card-header bg-light py-3 rounded-top">
                        <h5 class="fw-bold mb-0 text-dark">Pregunta 4 (Ritmo)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartP4" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>


    {% elif is_audit_page %}
        <div class="row">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between border-bottom pb-3 mt-4 mb-4">
                    <div>
                        <h2 class="text-secondary fw-bold mb-1">Registro de Auditoría</h2>
                        <p class="text-muted small mb-0">Cadena de custodia y detalles de integridad de los votos.</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill">
                            <i class="bi bi-shield-lock-fill me-1"></i> Modo Administrador
                        </span>
                    </div>
                </div>
                
                <div class="mb-5">
                    <h5 class="fw-bold text-dark mb-3">
                        <i class="bi bi-clipboard-data me-2 text-primary"></i>Referencia del Cuestionario
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm bg-light">
                                <div class="card-body position-relative overflow-hidden">
                                    <div class="position-absolute top-0 start-0 h-100 bg-primary" style="width: 4px;"></div>
                                    <div class="ms-2">
                                        <h6 class="text-primary fw-bold text-uppercase small mb-2">Pregunta 1 (P1): Interés</h6>
                                        <p class="fw-semibold text-dark mb-3" style="font-size: 0.95rem;">
                                            ¿Cuál fue tu nivel de interés general en los temas vistos en la clase?
                                        </p>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-white text-secondary border fw-normal">a) Alto</span>
                                            <span class="badge bg-white text-secondary border fw-normal">b) Medio</span>
                                            <span class="badge bg-white text-secondary border fw-normal">c) Bajo</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm bg-light">
                                <div class="card-body position-relative overflow-hidden">
                                    <div class="position-absolute top-0 start-0 h-100 bg-danger" style="width: 4px;"></div>
                                    <div class="ms-2">
                                        <h6 class="text-danger fw-bold text-uppercase small mb-2">Pregunta 2 (P2): Dificultad</h6>
                                        <p class="fw-semibold text-dark mb-3" style="font-size: 0.95rem;">
                                            ¿Cómo te pareció la dificultad de las tareas y proyectos del curso?
                                        </p>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-white text-secondary border fw-normal">a) Fáciles</span>
                                            <span class="badge bg-white text-secondary border fw-normal">b) Adecuados</span>
                                            <span class="badge bg-white text-secondary border fw-normal">c) Difíciles</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm bg-light">
                                <div class="card-body position-relative overflow-hidden">
                                    <div class="position-absolute top-0 start-0 h-100 bg-warning" style="width: 4px;"></div>
                                    <div class="ms-2">
                                        <h6 class="text-warning fw-bold text-uppercase small mb-2" style="filter: brightness(0.85);">Pregunta 3 (P3): Utilidad</h6>
                                        <p class="fw-semibold text-dark mb-3" style="font-size: 0.95rem;">
                                            ¿Consideras que los conceptos aprendidos en la clase te serán útiles?
                                        </p>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-white text-secondary border fw-normal">a) Sí, mucho</span>
                                            <span class="badge bg-white text-secondary border fw-normal">b) Tal vez</span>
                                            <span class="badge bg-white text-secondary border fw-normal">c) No, lo dudo</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm bg-light">
                                <div class="card-body position-relative overflow-hidden">
                                    <div class="position-absolute top-0 start-0 h-100 bg-success" style="width: 4px;"></div>
                                    <div class="ms-2">
                                        <h6 class="text-success fw-bold text-uppercase small mb-2">Pregunta 4 (P4): Ritmo</h6>
                                        <p class="fw-semibold text-dark mb-3" style="font-size: 0.95rem;">
                                            ¿Cómo calificarías el ritmo al que se cubrieron los temas durante el semestre?
                                        </p>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-white text-secondary border fw-normal">a) Muy rápido</span>
                                            <span class="badge bg-white text-secondary border fw-normal">b) Adecuado</span>
                                            <span class="badge bg-white text-secondary border fw-normal">c) Muy lento</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <div class="d-flex align-items-center mb-2">
                        <h5 class="fw-bold text-dark m-0"><i class="bi bi-table me-2 text-secondary"></i>Tabla de Registros</h5>
                    </div>
                    <table class="table table-striped table-bordered table-hover small shadow-sm rounded-3 overflow-hidden">
                        <thead class="table-dark">
                            <tr>
                                <th class="id-column text-center">#</th>
                                <th class="answer-column">Interés (P1)</th>
                                <th class="answer-column">Dificultad (P2)</th>
                                <th class="answer-column">Utilidad (P3)</th>
                                <th class="answer-column">Ritmo (P4)</th>
                                <th class="text-center hash-column">Voto cifrado (AES-256)</th> 
                                <th class="text-center hash-column">Firma digital (RSA)</th>
                                <th class="voter-column">Votante</th>
                                <th class="date-column">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vote in votes %}
                            <tr class="align-middle">
                                <td class="text-center fw-bold text-muted">{{ vote.id }}</td>
                                <td class="text-primary-strong answer-column">{{ vote.P1 }}</td>
                                <td class="answer-column">{{ vote.P2 }}</td>
                                <td class="answer-column">{{ vote.P3 }}</td>
                                <td class="answer-column">{{ vote.P4 }}</td>
                                
                                <td class="text-break text-center text-secondary fst-italic hash-complete hash-column bg-light">
                                    <i class="bi bi-lock-fill me-1 small text-muted"></i>{{ vote.encrypted_vote }}
                                </td>
                                <td class="text-break text-center text-success fw-bold hash-complete hash-column">
                                    <i class="bi bi-pen-fill me-1 small text-success opacity-50"></i>{{ vote.digital_signature }}
                                </td>
                                <td class="fw-semibold">{{ vote.voter_username }}</td>
                                <td class="text-muted">{{ vote.timestamp|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center p-5">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
                                        Aún no hay votos registrados en la auditoría.
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        
    {% elif is_verification_page %}
        <div class="row justify-content-center mt-5 pt-4">
            <div class="col-md-10">
                <table class="table table-striped table-bordered table-hover small shadow-sm rounded-3 overflow-hidden mt-4">
                    <thead class="table-dark">
                        <tr>
                            <th class="voter-column">Votante</th>
                            <th class="id-column">ID Voto</th>
                            <th class="text-center hash-column">Voto cifrado</th> 
                            <th class="text-center hash-column">Firma digital</th>
                            <th class="date-column">Fecha y hora del registro</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vote in votes %}
                        <tr class="align-middle">
                            <td>{{ vote.voter.user.username }}</td>
                            <td>{{ vote.id }}</td>
                            <td class="text-break text-center text-secondary fst-italic hash-complete hash-column">
                                {{ vote.encrypted_vote }}
                            </td>
                            <td class="text-break text-center text-success fw-bold hash-complete hash-column">
                                {{ vote.digital_signature }}
                            </td>
                            <td>{{ vote.timestamp|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center p-4 text-muted">Tu voto aún no ha sido registrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
    </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
    // --- LÓGICA DE DIBUJO DE GRÁFICOS SOLO SI NO ES LA PÁGINA DE VERIFICACIÓN O AUDITORÍA ---
    
    {% if not is_verification_page and not is_audit_page %} 
    
    // Función para dibujar un gráfico de dona/anillo
    function drawChart(elementId, optionsJson, countsJson, titleText) {
        // Parsear los datos de JSON.
        const labels = JSON.parse(optionsJson);
        const data = JSON.parse(countsJson);

        // Si no hay datos (porque la lista está vacía), muestra un mensaje y termina.
        if (data.length === 0 || data.every(count => count === 0)) {
            const ctx = document.getElementById(elementId);
            if (ctx) {
                const parent = ctx.parentElement;
                // Sustituimos el canvas por un mensaje
                parent.innerHTML = '<div class="text-center p-5 text-muted">Aún no hay votos registrados para este análisis.</div>';
            }
            return; 
        }

        const backgroundColors = [
            'rgba(41, 121, 255, 0.9)',  // Azul
            'rgba(255, 99, 132, 0.9)', // Rojo
            'rgba(255, 193, 7, 0.9)',  // Amarillo
            'rgba(40, 167, 69, 0.9)',  // Verde
            'rgba(153, 102, 255, 0.9)', // Violeta
        ];
        
        const borderColors = backgroundColors.map(color => color.replace('0.9', '1'));

        const ctx = document.getElementById(elementId).getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut', 
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votos',
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: borderColors.slice(0, labels.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 14, family: 'Inter' }
                        }
                    },
                    title: {
                        display: true,
                        text: titleText, 
                        font: { size: 18, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                // Cálculo de porcentaje
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const currentValue = context.raw;
                                const percentage = ((currentValue / total) * 100).toFixed(1);

                                return label + currentValue + ' votos (' + percentage + '%)';
                            }
                        }
                    }
                },
            },
        });
    }

    // --- Dibujar los 4 gráficos ---
    drawChart(
        'chartP1',
        '{{ options_json_p1|safe|escapejs|default:"[]" }}', 
        '{{ counts_json_p1|safe|escapejs|default:"[]" }}',
        'Distribución de Interés General'
    );
    
    drawChart(
        'chartP2',
        '{{ options_json_p2|safe|escapejs|default:"[]" }}',
        '{{ counts_json_p2|safe|escapejs|default:"[]" }}',
        'Dificultad de Tareas y Proyectos'
    );

    drawChart(
        'chartP3',
        '{{ options_json_p3|safe|escapejs|default:"[]" }}',
        '{{ counts_json_p3|safe|escapejs|default:"[]" }}',
        'Utilidad de los Conceptos Aprendidos'
    );
    
    drawChart(
        'chartP4',
        '{{ options_json_p4|safe|escapejs|default:"[]" }}',
        '{{ counts_json_p4|safe|escapejs|default:"[]" }}',
        'Ritmo de Cobertura de Temas'
    );
    
    {% endif %}

</script>
{% endblock content %}